{"version":3,"sources":["../../../../src/lib/prisma.ts","turbopack:///[project]/node_modules/openid-client/package.json","../../../../src/lib/workflow.ts","../../../../src/app/actions/workflow.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst prismaClientSingleton = () => {\n    return new PrismaClient()\n}\n\ndeclare global {\n    var prismaGlobal: undefined | ReturnType<typeof prismaClientSingleton>\n}\n\nconst prisma = globalThis.prismaGlobal ?? prismaClientSingleton()\n\nexport default prisma\n\nif (process.env.NODE_ENV !== 'production') globalThis.prismaGlobal = prisma\n","{\"name\":\"openid-client\",\"version\":\"5.7.1\",\"description\":\"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs\",\"keywords\":[\"auth\",\"authentication\",\"basic\",\"certified\",\"client\",\"connect\",\"dynamic\",\"electron\",\"hybrid\",\"identity\",\"implicit\",\"oauth\",\"oauth2\",\"oidc\",\"openid\",\"passport\",\"relying party\",\"strategy\"],\"homepage\":\"https://github.com/panva/openid-client\",\"repository\":\"panva/openid-client\",\"funding\":{\"url\":\"https://github.com/sponsors/panva\"},\"license\":\"MIT\",\"author\":\"Filip Skokan <panva.ip@gmail.com>\",\"exports\":{\"types\":\"./types/index.d.ts\",\"import\":\"./lib/index.mjs\",\"require\":\"./lib/index.js\"},\"main\":\"./lib/index.js\",\"types\":\"./types/index.d.ts\",\"files\":[\"lib\",\"types/index.d.ts\"],\"scripts\":{\"format\":\"npx prettier --loglevel silent --write ./lib ./test ./certification ./types\",\"test\":\"mocha test/**/*.test.js\"},\"dependencies\":{\"jose\":\"^4.15.9\",\"lru-cache\":\"^6.0.0\",\"object-hash\":\"^2.2.0\",\"oidc-token-hash\":\"^5.0.3\"},\"devDependencies\":{\"@types/node\":\"^16.18.106\",\"@types/passport\":\"^1.0.16\",\"base64url\":\"^3.0.1\",\"chai\":\"^4.5.0\",\"mocha\":\"^10.7.3\",\"nock\":\"^13.5.5\",\"prettier\":\"^2.8.8\",\"readable-mock-req\":\"^0.2.2\",\"sinon\":\"^9.2.4\",\"timekeeper\":\"^2.3.1\"},\"standard-version\":{\"scripts\":{\"postchangelog\":\"sed -i '' -e 's/### \\\\[/## [/g' CHANGELOG.md\"},\"types\":[{\"type\":\"feat\",\"section\":\"Features\"},{\"type\":\"fix\",\"section\":\"Fixes\"},{\"type\":\"chore\",\"hidden\":true},{\"type\":\"docs\",\"hidden\":true},{\"type\":\"style\",\"hidden\":true},{\"type\":\"refactor\",\"section\":\"Refactor\",\"hidden\":false},{\"type\":\"perf\",\"section\":\"Performance\",\"hidden\":false},{\"type\":\"test\",\"hidden\":true}]}}","export type RequestStatus =\n    | \"SUBMITTED\"\n    | \"AWAITING_TRAINER_CONFIRMATION\"\n    | \"TRAINER_CONFIRMED\"\n    | \"AWAITING_APPROVER_1\"\n    | \"AWAITING_APPROVER_2\"\n    | \"CONFIRMED\"\n    | \"REJECTED\"\n    | \"NO_TRAINER_AVAILABLE\";\n\nexport const ALLOWED_TRANSITIONS: Record<RequestStatus, RequestStatus[]> = {\n    SUBMITTED: [\"AWAITING_TRAINER_CONFIRMATION\", \"NO_TRAINER_AVAILABLE\"],\n    AWAITING_TRAINER_CONFIRMATION: [\"TRAINER_CONFIRMED\", \"REJECTED\", \"NO_TRAINER_AVAILABLE\"], // Trainer accepts or rejects\n    TRAINER_CONFIRMED: [\"AWAITING_APPROVER_1\", \"REJECTED\"],\n    AWAITING_APPROVER_1: [\"CONFIRMED\", \"AWAITING_APPROVER_2\", \"REJECTED\"], // Appr 1 accepts (-> Confirmed or Appr 2) or rejects\n    AWAITING_APPROVER_2: [\"CONFIRMED\", \"REJECTED\"],\n    CONFIRMED: [], // Terminal\n    REJECTED: [\"SUBMITTED\"], // Can be resubmitted (maybe creates new request or resets this one?)\n    NO_TRAINER_AVAILABLE: [\"SUBMITTED\", \"REJECTED\"], // Admin can re-trigger or reject\n};\n\nexport const ROLE_PERMISSIONS: Record<string, RequestStatus[]> = {\n    SALES: [\"SUBMITTED\"], // Sales can only \"Submit\" (create)\n    TRAINER: [\"TRAINER_CONFIRMED\", \"REJECTED\", \"AWAITING_TRAINER_CONFIRMATION\"], // Trainer can act on these\n    APPROVER: [\"CONFIRMED\", \"REJECTED\", \"AWAITING_APPROVER_2\"],\n    ADMIN: [\"SUBMITTED\", \"AWAITING_TRAINER_CONFIRMATION\", \"TRAINER_CONFIRMED\", \"AWAITING_APPROVER_1\", \"AWAITING_APPROVER_2\", \"CONFIRMED\", \"REJECTED\", \"NO_TRAINER_AVAILABLE\"],\n};\n\nexport function canTransition(currentStatus: string, nextStatus: string): boolean {\n    const allowed = ALLOWED_TRANSITIONS[currentStatus as RequestStatus];\n    return allowed ? allowed.includes(nextStatus as RequestStatus) : false;\n}\n\nexport function getNextStatus(currentStatus: string, action: \"APPROVE\" | \"REJECT\", discountPercent: number): string {\n    if (action === \"REJECT\") return \"REJECTED\";\n\n    switch (currentStatus) {\n        case \"AWAITING_TRAINER_CONFIRMATION\":\n            return \"TRAINER_CONFIRMED\";\n        case \"TRAINER_CONFIRMED\":\n            return \"AWAITING_APPROVER_1\";\n        case \"AWAITING_APPROVER_1\":\n            // If discount > 20%, need Approver 2\n            if (discountPercent > 20) return \"AWAITING_APPROVER_2\";\n            return \"CONFIRMED\";\n        case \"AWAITING_APPROVER_2\":\n            return \"CONFIRMED\";\n        default:\n            return currentStatus;\n    }\n}\n","\"use server\";\n\nimport { canTransition, getNextStatus } from \"@/lib/workflow\";\nimport prisma from \"@/lib/prisma\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport { revalidatePath } from \"next/cache\";\n\nexport async function processWorkflowAction(\n    requestId: string,\n    action: \"APPROVE\" | \"REJECT\",\n    reason?: string\n) {\n    const session = await getServerSession(authOptions);\n    if (!session || !session.user) return { error: \"Unauthorized\" };\n\n    const userRole = (session.user as any).role;\n    // TODO: Add strict RBAC check based on current status vs user role\n\n    const request = await prisma.trainingRequest.findUnique({\n        where: { id: requestId },\n    });\n\n    if (!request) return { error: \"Request not found\" };\n\n    const nextStatus = getNextStatus(request.status, action, request.discountPercent);\n\n    if (!canTransition(request.status, nextStatus)) {\n        return { error: `Invalid transition from ${request.status} to ${nextStatus}` };\n    }\n\n    // Update Request\n    await prisma.trainingRequest.update({\n        where: { id: requestId },\n        data: {\n            status: nextStatus,\n            approvals: {\n                create: {\n                    userId: (session.user as any).id,\n                    stage: request.status,\n                    decision: action,\n                    reason: reason,\n                },\n            },\n            // If CONFIRMED, we might want to create the final CalendarEvent here\n        },\n    });\n\n    if (nextStatus === \"CONFIRMED\") {\n        // Create Confirmed Calendar Event\n        if (request.trainerId) {\n            // Check if one exists first?\n            // Just create new confirmed event\n            await prisma.calendarEvent.create({\n                data: {\n                    requestId: request.id,\n                    trainerId: request.trainerId,\n                    start: request.startDate,\n                    end: request.endDate,\n                    type: \"CONFIRMED\",\n                }\n            });\n\n            // Also maybe delete TENTATIVE ones?\n        }\n    }\n\n    // TODO: Trigger Email Notifications\n\n    revalidatePath(`/requests/${request.reference}`);\n    revalidatePath(\"/trainer/inbox\");\n    revalidatePath(\"/approver/inbox\");\n    return { success: true };\n}\n"],"names":[],"mappings":"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"}